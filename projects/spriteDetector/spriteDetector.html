<!DOCTYPE html>
<html>
<body>
  <img id="forest" src="Forest (3).png" style="display: none;">
  <canvas id="canvas" style="border: 1px solid black;"></canvas>
  <p id="detectedColor" style="font-family: sans-serif; width:50px;height:50px;border:1px solid black;margin:10px;"></p>
  <script>
    var tolerance = 10, numSamples = 10, image = document.getElementById('forest'), canvas = document.getElementById('canvas'), detectedColorDiv = document.getElementById('detectedColor'), ctx = canvas.getContext('2d'), backgroundColor = null, seeds = [], extractedSprites = [], appendSpriteSize = 300, debug = true;

    let isForeground = (testColor) => {
      return Math.abs(testColor[0] - backgroundColor[0]) > tolerance || Math.abs(testColor[1] - backgroundColor[1]) > tolerance || Math.abs(testColor[2] - backgroundColor[2]) > tolerance;
    };

    let isBackground = (testColor) => {
      return Math.abs(testColor[0] - backgroundColor[0]) <= tolerance && Math.abs(testColor[1] - backgroundColor[1]) <= tolerance && Math.abs(testColor[2] - backgroundColor[2]) <= tolerance;
    };

    let globalVisited = new Set();

    function extractSprite(seed) {
      let spriteData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
      const stack = [seed];
      const localVisited = new Set();

      if (extractedSprites.some(extractedSprite => extractedSprite && isPointInSprite(seed, extractedSprite))) {
        return null;
      }

      while (stack.length > 0) {
        let point = stack.pop();
        let x = point.x, y = point.y;
        const key = `${x},${y}`;

        if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height || localVisited.has(key) || globalVisited.has(key)) continue;

        let currentColor = [
          spriteData.data[(y * canvas.width + x) * 4],
          spriteData.data[(y * canvas.width + x) * 4 + 1],
          spriteData.data[(y * canvas.width + x) * 4 + 2]
        ];

        if (isBackground(currentColor)) continue;

        minX = Math.min(minX, x);
        minY = Math.min(minY, y);
        maxX = Math.max(maxX, x);
        maxY = Math.max(maxY, y);

        localVisited.add(key);
        globalVisited.add(key);

        stack.push({ x: x + 1, y: y });
        stack.push({ x: x - 1, y: y });
        stack.push({ x: x, y: y + 1 });
        stack.push({ x: x, y: y - 1 });
      }

      if (minX > maxX || minY > maxY) {
        console.log("Invalid sprite dimensions: ", { minX, minY, maxX, maxY });
        return null;
      }

      let spriteWidth = maxX - minX + 1;
      let spriteHeight = maxY - minY + 1;
      let sprite = ctx.createImageData(spriteWidth, spriteHeight);

      for (let y = minY; y <= maxY; y++) {
        for (let x = minX; x <= maxX; x++) {
          const pixelIndex = (y * canvas.width + x) * 4;
          const spritePixelIndex = ((y - minY) * spriteWidth + (x - minX)) * 4;

          let currentColor = [
            spriteData.data[pixelIndex],
            spriteData.data[pixelIndex + 1],
            spriteData.data[pixelIndex + 2]
          ];

          if (!isBackground(currentColor)) {
            sprite.data[spritePixelIndex] = spriteData.data[pixelIndex];
            sprite.data[spritePixelIndex + 1] = spriteData.data[pixelIndex + 1];
            sprite.data[spritePixelIndex + 2] = spriteData.data[pixelIndex + 2];
            sprite.data[spritePixelIndex + 3] = 255;
          }
        }
      }

      const spriteObject = { sprite, minX, minY, maxX, maxY };
      extractedSprites.push(spriteObject);
      return spriteObject;
    }

    function isPointInSprite(point, spriteObject) {
      if (!spriteObject || !spriteObject.sprite) {
        console.log("Invalid sprite object: ", spriteObject);
        return false;
      }
      const x = point.x - spriteObject.minX;
      const y = point.y - spriteObject.minY;
      if (x < 0 || y < 0 || x >= spriteObject.sprite.width || y >= spriteObject.sprite.height) {
        return false;
      }
      const pixelIndex = (y * spriteObject.sprite.width + x) * 4;
      return spriteObject.sprite.data[pixelIndex + 3] > 0;
    }

    function drawSprite(spriteObject) {
      if (spriteObject === null) return;

      const { sprite, minX, minY, maxX, maxY } = spriteObject;
      let spriteWidth = maxX - minX + 1, spriteHeight = maxY - minY + 1;

      const spriteCanvas = document.createElement('canvas');
      spriteCanvas.width = spriteWidth;
      spriteCanvas.height = spriteHeight;
      const spriteCtx = spriteCanvas.getContext('2d');

      spriteCtx.putImageData(sprite, 0, 0);

      const img = document.createElement('img');
      img.src = spriteCanvas.toDataURL();
      img.width = spriteWidth;
      img.height = spriteHeight;
      document.body.appendChild(img);
    }

    document.getElementById('forest').onload = function() {
      canvas.width = image.width;
      canvas.height = image.height;
      ctx.drawImage(image, 0, 0);
      backgroundColor = [ctx.getImageData(0, 0, 1, 1).data[0], ctx.getImageData(0, 0, 1, 1).data[1], ctx.getImageData(0, 0, 1, 1).data[2]];
      detectedColorDiv.style.backgroundColor = `rgb(${backgroundColor[0]}, ${backgroundColor[1]}, ${backgroundColor[2]})`;
      seeds = getRandomForegroundSeeds(canvas, isForeground, numSamples);
      if (debug) {
        ctx.fillStyle = 'red';
        seeds.forEach(seed => ctx.fillRect(seed.x, seed.y, 5, 5));
      }
      seeds.forEach(seed => {
        const spriteObject = extractSprite(seed);
        if (spriteObject) {
          drawSprite(spriteObject);
        }
      });
    };

    function getRandomForegroundSeeds(canvas, isForeground, numSamples) {
      return Array.from({ length: numSamples }).map(() => ({
        x: Math.floor(Math.random() * canvas.width),
        y: Math.floor(Math.random() * canvas.height)
      })).filter(point => isForeground(ctx.getImageData(point.x, point.y, 1, 1).data));
    }
  </script>
</body>
</html>
